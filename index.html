<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Math Algorithm Composer</title>
  <style>
    #renderArea {
        font-family: 'Times New Roman', serif;
    }
    .matdowncontainer {
        padding: 10px;
        margin: 20px;
        max-width: 600px;
    }
    /* Expression wrapper: inline by default */
    .matdowncontainer .matdowninline-expression {
        display: inline-flex;
        align-items: center;
        margin: 2px;
    }
    .matdowncontainer .matdownoperator {
        margin: 0 5px;
        font-weight: bold;
    }
    /* Fraction style for division */
    .matdowncontainer .matdownfraction {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        margin: 2px;
    }
    .matdowncontainer .matdownnumerator {
        border-bottom: 1px solid #000;
        padding: 2px 4px;
        white-space: nowrap;
    }
    .matdowncontainer .matdowndenominator {
        padding: 2px 4px;
        white-space: nowrap;
    }
    /* Grouped parentheses (optional styling) */
    .matdowncontainer .matdowngroup {
        display: inline-block;
        padding: 2px 6px;
        border: 1px dashed #ccc;
        border-radius: 4px;
        margin: 2px;
    }
    /* Exponent style */
    .matdowncontainer .matdownexponent {
        display: inline-block;
        vertical-align: super;
        font-size: 0.8em;
        margin-top: -10px;
    }
    /* General styling for buttons/inputs scoped to our container */
    .matdowncontainer button {
        margin-top: 10px;
        cursor: pointer;
    }
    .matdowncontainer input[type="text"] {
        width: 300px;
        padding: 4px;
    }
    .matdowncontainer textarea {
        width: 100%;
        height: 100px;
        margin-top: 10px;
        font-family: monospace;
    }
    /* context menu styles */
    #matdownContextMenu {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      padding: 8px;
      z-index: 9999;
      width: 220px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    #searchSymbols {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      margin-bottom: 8px;
    }
    #symbolList {
      max-height: 200px;
      overflow-y: auto;
    }
    .symbolItem {
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .symbolItem:hover {
      background: #eee;
    }
  </style>
</head>
<body>

<div class="matdowncontainer">
  <h3>Input </h3>
    -Right-click to insert symbols. (only works when page is parent)
  <input type="text" id="algorithmInput" placeholder="Example: (3^2+1)/(19−10)">
  <button id="render">Render Algorithm</button>

  <h3>Output:</h3>
  <div id="renderArea"></div>

  <h3>Embeddable HTML Output:</h3>
  <textarea id="htmlOutput" readonly></textarea>
</div>

<!-- Custom context menu (it will also be scoped by our container if moved inside) -->
<div id="matdownContextMenu">
  <input type="text" id="searchSymbols" placeholder="Search symbols...">
  <div id="symbolList"></div>
</div>

<script type="module">
import MathParser from './syntax/parser.mjs';
import MathHtmlEmmiter from './backend/htmlEmmiter.mjs';

/**
 * Public function to parse the input string and produce HTML
 */
function parseAndRender(expr) {
  const parser = new MathParser(expr);
  const emmiter = new MathHtmlEmmiter();

  const tree = parser.parse();
  return emmiter.visit(tree);
}

/**
 * Reads the input, parses & renders, and updates the DOM
 */
function renderAlgorithm() {
  const input = document.getElementById('algorithmInput').value;
  const outputHTML = parseAndRender(input);
  document.getElementById('renderArea').innerHTML = outputHTML;
  document.getElementById('htmlOutput').value =
    '<div class="algorithm">\n' + outputHTML + '\n</div>';
}

document.getElementById('render').onclick = renderAlgorithm;

// ========================================
// Right-click symbol insertion logic
// ========================================
const mathSymbols = [{ symbol: '±', name: 'plus minus' }, { symbol: '−', name: 'minus sign' }, { symbol: '×', name: 'times sign' }, { symbol: '÷', name: 'division sign' }, { symbol: '∞', name: 'infinity' }, { symbol: '≠', name: 'not equal' }, { symbol: '≈', name: 'approximately equal' }, { symbol: '≡', name: 'equivalent to' }, { symbol: '≅', name: 'congruent to' }, { symbol: '∴', name: 'therefore' }, { symbol: '∵', name: 'because' }, { symbol: '∑', name: 'summation' }, { symbol: '∏', name: 'product' }, { symbol: '∫', name: 'integral' }, { symbol: '∂', name: 'partial derivative' }, { symbol: '√', name: 'square root' }, { symbol: '³', name: 'cube exponent' }, { symbol: '²', name: 'square exponent' }, { symbol: '°', name: 'degree' }, { symbol: '∀', name: 'for all' }, { symbol: '∃', name: 'there exists' }, { symbol: '∈', name: 'element of' }, { symbol: '⇒', name: 'implies' }, { symbol: '⇔', name: 'if and only if' }, { symbol: '→', name: 'right arrow' }, { symbol: '←', name: 'left arrow' }, { symbol: '↑', name: 'up arrow' }, { symbol: '↓', name: 'down arrow' }, { symbol: '⊂', name: 'subset of' }, { symbol: '⊆', name: 'subset or equal' }, { symbol: '⊄', name: 'not a subset of' }, { symbol: '∅', name: 'empty set' }, { symbol: '∧', name: 'logical and' }, { symbol: '∨', name: 'logical or' }, { symbol: '¬', name: 'logical not' }, { symbol: '⊕', name: 'circled plus' }, { symbol: '⊗', name: 'circled times' }, { symbol: '≤', name: 'less than or equal' }, { symbol: '≥', name: 'greater than or equal' }, { symbol: 'Σ', name: 'capital sigma' }, { symbol: 'Π', name: 'capital pi' }, { symbol: 'Γ', name: 'capital gamma' }, { symbol: 'Λ', name: 'capital lambda' }, { symbol: 'Δ', name: 'capital delta' }, { symbol: 'α', name: 'alpha' }, { symbol: 'β', name: 'beta' }, { symbol: 'γ', name: 'gamma' }, { symbol: 'δ', name: 'delta' }, { symbol: 'θ', name: 'theta' }, { symbol: 'λ', name: 'lambda' }, { symbol: 'μ', name: 'mu' }, { symbol: 'π', name: 'pi' }, { symbol: 'φ', name: 'phi' }, { symbol: 'ω', name: 'omega' }];
const matdowninputEl = document.getElementById('algorithmInput');
const matdownContextMenuEl = document.getElementById('matdownContextMenu');
const searchEl = document.getElementById('searchSymbols');
const symbolListEl = document.getElementById('symbolList');
let lastCaretPosition = 0;

matdowninputEl.addEventListener('contextmenu', (e) => {
  e.preventDefault();
  lastCaretPosition = matdowninputEl.selectionStart;
  matdownContextMenuEl.style.left = e.pageX + 'px';
  matdownContextMenuEl.style.top = e.pageY + 'px';
  searchEl.value = '';
  renderSymbols(mathSymbols);
  matdownContextMenuEl.style.display = 'block';
  searchEl.focus();
});

document.addEventListener('click', (e) => {
  if (!matdownContextMenuEl.contains(e.target) && e.target !== matdowninputEl) {
    matdownContextMenuEl.style.display = 'none';
  }
});

searchEl.addEventListener('input', () => {
  const query = searchEl.value.toLowerCase();
  const filtered = mathSymbols.filter(item =>
    item.symbol.includes(query) || item.name.includes(query)
  );
  renderSymbols(filtered);
});

function renderSymbols(symbols) {
  symbolListEl.innerHTML = '';
  symbols.forEach(item => {
    const div = document.createElement('div');
    div.className = 'symbolItem';
    div.textContent = `${item.symbol} (${item.name})`;
    div.onclick = () => insertSymbol(item.symbol);
    symbolListEl.appendChild(div);
  });
}

function insertSymbol(symbol) {
  const v = matdowninputEl.value;
  matdowninputEl.value = v.slice(0, lastCaretPosition) + symbol + v.slice(lastCaretPosition);
  matdowninputEl.focus();
  matdowninputEl.setSelectionRange(lastCaretPosition + symbol.length, lastCaretPosition + symbol.length);
  matdownContextMenuEl.style.display = 'none';
}

renderSymbols(mathSymbols);
</script>

</body>
</html>
