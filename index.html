<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Math Algorithm Composer</title>
  <style>
    #renderArea {
        font-family: 'Times New Roman', serif;
    }
    .matdowncontainer {
        padding: 10px;
        margin: 20px;
        max-width: 600px;
    }
    /* Expression wrapper: inline by default */
    .matdowncontainer .matdowninline-expression {
        display: inline-flex;
        align-items: center;
        margin: 2px;
    }
    .matdowncontainer .matdownoperator {
        margin: 0 5px;
        font-weight: bold;
    }
    /* Fraction style for division */
    .matdowncontainer .matdownfraction {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        margin: 2px;
    }
    .matdowncontainer .matdownnumerator {
        border-bottom: 1px solid #000;
        padding: 2px 4px;
        white-space: nowrap;
    }
    .matdowncontainer .matdowndenominator {
        padding: 2px 4px;
        white-space: nowrap;
    }
    /* Grouped parentheses (optional styling) */
    .matdowncontainer .matdowngroup {
        display: inline-block;
        padding: 2px 6px;
        border: 1px dashed #ccc;
        border-radius: 4px;
        margin: 2px;
    }
    .matdownselected {
        background-color: aqua;
    }
    .matdownkeyboard {
        margin-top: 10px;
        display: flex;
        flex-direction: row;
        gap: 10px;
        flex-wrap: wrap;
    }
    .matdownkeyboard > div {
        border: 1px solid black;
        padding: 10px;
    }
    /* Exponent style */
    .matdowncontainer .matdownexponent {
        display: inline-block;
        vertical-align: super;
        font-size: 0.8em;
        margin-top: -10px;
    }
    /* General styling for buttons/inputs scoped to our container */
    .matdowncontainer button {
        margin-top: 10px;
        cursor: pointer;
    }
    .matdowncontainer input[type="text"] {
        width: 300px;
        padding: 4px;
    }
    .matdowncontainer textarea {
        width: 100%;
        height: 100px;
        margin-top: 10px;
        font-family: monospace;
    }
    /* context menu styles */
    #matdownContextMenu {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      padding: 8px;
      z-index: 9999;
      width: 220px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    #searchSymbols {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      margin-bottom: 8px;
    }
    #symbolList {
      max-height: 200px;
      overflow-y: auto;
    }
    .symbolItem {
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .symbolItem:hover {
      background: #eee;
    }
  </style>
</head>
<body>

<div class="matdowncontainer">
  <h3>Formula:</h3>
  <div id="renderArea"></div>
  <div class="matdownkeyboard">
    <div id="delete">⌫</div>
    <div id="left">←</div>
    <div id="right">→</div>
    <div id="up">↑</div>
    <div id="digit0"></div>
    <div id="digit1"></div>
    <div id="digit2"></div>
    <div id="digit3"></div>
    <div id="digit4"></div>
    <div id="digit5"></div>
    <div id="digit6"></div>
    <div id="digit7"></div>
    <div id="digit8"></div>
    <div id="digit9"></div>
    <div id="seperator">.</div>
    <div id="a"></div>
    <div id="b"></div>
    <div id="c"></div>
    <div id="x"></div>
    <div id="y"></div>
    <div id="z"></div>
    <div id="equals"></div>
    <div id="notEquals"></div>
    <div id="less"></div>
    <div id="greater"></div>
    <div id="lessEquals"></div>
    <div id="greaterEquals"></div>
    <div id="plus"></div>
    <div id="minus"></div>
    <div id="times"></div>
    <div id="division"></div>
    <div id="fraction"></div>
    <div id="exponent"></div>
  </div>

  <h3>Embeddable HTML Output:</h3>
  <textarea id="htmlOutput" readonly></textarea>
</div>

<script type="module">
import {MathDigitNode, MathCharacterNode, MathOperationNode, MathPlaceholderNode, MathExponentNode, MathFractionNode} from './ast/index.mjs';
import MathKeyboard from './keyboard/index.mjs';
import MathHtmlEmmiter from './output/htmlEmmiter.mjs';
import symbols from './syntax/symbols.mjs';

const keyboard = new MathKeyboard();
const emmiter = new MathHtmlEmmiter(keyboard);

function display() {
  const outputHTML = emmiter.visit(keyboard.root);
  document.getElementById('renderArea').innerHTML = '';
  document.getElementById('renderArea').appendChild(outputHTML);
  document.getElementById('htmlOutput').value = '<div class="algorithm">\n' + outputHTML.innerHTML + '\n</div>';
}

function registerNodeKey(elementId, key, create, insert=keyboard.insert) {
  const element = document.getElementById(elementId);

  const placeholder = new MathPlaceholderNode();
  placeholder.node = create();
  placeholder.node.parentPlaceholder = placeholder.node;
  const contents = emmiter.visit(placeholder);

  element.appendChild(contents);
  
  const handleInsert = () => {
    insert.bind(keyboard)(create());
    display();
  };

  element.onclick = handleInsert;

  if (key) {
    document.addEventListener("keyup", (event) => {
      if (event.key === key) {
        handleInsert();
        event.stopPropagation();
      }
    });
  }
}

for (let digit = 0; digit < 10; digit++) {
  registerNodeKey('digit' + digit, digit.toString(), () => new MathDigitNode(digit), keyboard.insertDigit);
}

for (let letter of ['a', 'b', 'c', 'x', 'y', 'z']) {
  registerNodeKey(letter, letter, () => new MathCharacterNode(letter), keyboard.insertCharacter);
}

registerNodeKey('equals', symbols.equals, () => new MathOperationNode(symbols.equals));
registerNodeKey('notEquals', symbols.notEquals, () => new MathOperationNode(symbols.notEquals));
registerNodeKey('less', symbols.less, () => new MathOperationNode(symbols.less));
registerNodeKey('greater', symbols.greater, () => new MathOperationNode(symbols.greater));
registerNodeKey('lessEquals', symbols.lessEquals, () => new MathOperationNode(symbols.lessEquals));
registerNodeKey('greaterEquals', symbols.greaterEquals, () => new MathOperationNode(symbols.greaterEquals));
registerNodeKey('plus', symbols.plus, () => new MathOperationNode(symbols.plus));
registerNodeKey('minus', symbols.minus, () => new MathOperationNode(symbols.minus));
registerNodeKey('times', symbols.times, () => new MathOperationNode(symbols.times));
registerNodeKey('division', symbols.division, () => new MathOperationNode(symbols.division));
registerNodeKey('fraction', symbols.fraction, () => new MathFractionNode());
registerNodeKey('exponent', symbols.exponent, () => new MathExponentNode());

document.getElementById('delete').onclick = () => {keyboard.delete(); display();};
document.getElementById('left').onclick = () => {keyboard.moveLeft(); display();};
document.getElementById('right').onclick = () => {keyboard.moveRight(); display();};
document.getElementById('up').onclick = () => {keyboard.moveUp(); display();};
document.getElementById('seperator').onclick = () => {keyboard.insertDecimalSeperator(); display();};
document.addEventListener("keyup", (event) => {
  let handled = true;

  switch (event.key) {
    case "Backspace":
    case "Delete":
      keyboard.delete();
      break;
    case "ArrowLeft":
      keyboard.moveLeft();
      break;
    case "ArrowRight":
      keyboard.moveRight();
      break;
    case "ArrowUp":
      keyboard.moveUp();
      break;
    case ".":
    case ",":
      keyboard.insertDecimalSeperator();
      break;
    default:
      handled = false;
      break;
  }

  if (handled) {
    event.stopPropagation();
    event.preventDefault();
    display();
  }
});

emmiter.onClick = display;
display();
</script>

</body>
</html>
