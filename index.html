<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Math Algorithm Composer</title>
  <style>
    #renderArea {
        font-family: 'Times New Roman', serif;
    }
    .matdowncontainer {
        padding: 10px;
        margin: 20px;
        max-width: 600px;
    }
    /* Expression wrapper: inline by default */
    .matdowncontainer .matdowninline-expression {
        display: inline-flex;
        align-items: center;
        margin: 2px;
    }
    .matdowncontainer .matdownoperator {
        margin: 0 5px;
        font-weight: bold;
    }
    /* Fraction style for division */
    .matdowncontainer .matdownfraction {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        margin: 2px;
    }
    .matdowncontainer .matdownnumerator {
        border-bottom: 1px solid #000;
        padding: 2px 4px;
        white-space: nowrap;
    }
    .matdowncontainer .matdowndenominator {
        padding: 2px 4px;
        white-space: nowrap;
    }
    /* Grouped parentheses (optional styling) */
    .matdowncontainer .matdowngroup {
        display: inline-block;
        padding: 2px 6px;
        border: 1px dashed #ccc;
        border-radius: 4px;
        margin: 2px;
    }
    .matdownselected {
        background-color: aqua;
    }
    .matdownkeyboard {
        margin-top: 10px;
        display: flex;
        flex-direction: row;
        gap: 10px;
        flex-wrap: wrap;
    }
    .matdownkeyboard > div {
        border: 1px solid black;
        padding: 10px;
    }
    /* Exponent style */
    .matdowncontainer .matdownexponent {
        display: inline-block;
        vertical-align: super;
        font-size: 0.8em;
        margin-top: -10px;
    }
    /* General styling for buttons/inputs scoped to our container */
    .matdowncontainer button {
        margin-top: 10px;
        cursor: pointer;
    }
    .matdowncontainer input[type="text"] {
        width: 300px;
        padding: 4px;
    }
    .matdowncontainer textarea {
        width: 100%;
        height: 100px;
        margin-top: 10px;
        font-family: monospace;
    }
    /* context menu styles */
    #matdownContextMenu {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      padding: 8px;
      z-index: 9999;
      width: 220px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    #searchSymbols {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      margin-bottom: 8px;
    }
    #symbolList {
      max-height: 200px;
      overflow-y: auto;
    }
    .symbolItem {
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .symbolItem:hover {
      background: #eee;
    }
  </style>
</head>
<body>

<div class="matdowncontainer">
  <h3>Formula:</h3>
  <div id="renderArea"></div>
  <div class="matdownkeyboard">
    <div id="delete">⌫</div>
    <div id="left">←</div>
    <div id="right">→</div>
    <div id="digit0"></div>
    <div id="digit1"></div>
    <div id="digit2"></div>
    <div id="digit3"></div>
    <div id="digit4"></div>
    <div id="digit5"></div>
    <div id="digit6"></div>
    <div id="digit7"></div>
    <div id="digit8"></div>
    <div id="digit9"></div>
    <div id="seperator">.</div>
    <div id="a"></div>
    <div id="b"></div>
    <div id="c"></div>
    <div id="x"></div>
    <div id="y"></div>
    <div id="z"></div>
    <div id="equals"></div>
    <div id="notEquals"></div>
    <div id="less"></div>
    <div id="greater"></div>
    <div id="lessEquals"></div>
    <div id="greaterEquals"></div>
    <div id="plus"></div>
    <div id="minus"></div>
    <div id="times"></div>
    <div id="division"></div>
    <div id="fraction"></div>
    <div id="exponent"></div>
  </div>

  <h3>Embeddable HTML Output:</h3>
  <textarea id="htmlOutput" readonly></textarea>
</div>

<script type="module">
import {MathDigitNode, MathCharacterNode, MathOperationNode, MathPlaceholderNode, MathExponentNode, MathFractionNode} from './ast/index.mjs';
import MathKeyboard from './keyboard/index.mjs';
import MathHtmlEmmiter from './backend/htmlEmmiter.mjs';
import symbols from './syntax/symbols.mjs';

const keyboard = new MathKeyboard();
const emmiter = new MathHtmlEmmiter(keyboard);

function display() {
  const outputHTML = emmiter.visit(keyboard.root);
  document.getElementById('renderArea').innerHTML = outputHTML;
  document.getElementById('htmlOutput').value = '<div class="algorithm">\n' + outputHTML + '\n</div>';
}

function registerNodeKey(elementId, create, insert=keyboard.insert) {
  const element = document.getElementById(elementId);

  const placeholder = new MathPlaceholderNode();
  placeholder.node = create();
  placeholder.node.parentPlaceholder = placeholder.node;
  const contents = emmiter.visit(placeholder);

  element.innerHTML = contents;
  element.onclick = () => {
    insert.bind(keyboard)(create());
    display();
  };
}

for (let digit = 0; digit < 10; digit++) {
  registerNodeKey('digit' + digit, () => new MathDigitNode(digit), keyboard.insertDigit);
}

for (let letter of ['a', 'b', 'c', 'x', 'y', 'z']) {
  registerNodeKey(letter, () => new MathCharacterNode(letter), keyboard.insertCharacter);
}

registerNodeKey('equals', () => new MathOperationNode(symbols.equals));
registerNodeKey('notEquals', () => new MathOperationNode(symbols.notEquals));
registerNodeKey('less', () => new MathOperationNode(symbols.less));
registerNodeKey('greater', () => new MathOperationNode(symbols.greater));
registerNodeKey('lessEquals', () => new MathOperationNode(symbols.lessEquals));
registerNodeKey('greaterEquals', () => new MathOperationNode(symbols.greaterEquals));
registerNodeKey('plus', () => new MathOperationNode(symbols.plus));
registerNodeKey('minus', () => new MathOperationNode(symbols.minus));
registerNodeKey('times', () => new MathOperationNode(symbols.times));
registerNodeKey('division', () => new MathOperationNode(symbols.division));
registerNodeKey('fraction', () => new MathFractionNode());
registerNodeKey('exponent', () => new MathExponentNode());

document.getElementById('delete').onclick = () => {keyboard.delete(); display();};
document.getElementById('left').onclick = () => {keyboard.moveLeft(); display();};
document.getElementById('right').onclick = () => {keyboard.moveRight(); display();};
document.getElementById('seperator').onclick = () => {keyboard.insertDecimalSeperator(); display();};

display();
</script>

</body>
</html>
